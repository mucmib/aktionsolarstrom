<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Solarstrom statt Erdgas-Strom – Brief einreichen</title>
  <link rel="stylesheet" href="assets/styles.css">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; }
    header { background: #000; color: #fff; padding: 20px; text-align: center; }
    header img { max-height: 60px; }
    main { max-width: 800px; margin: 20px auto; padding: 20px; }
    form label { display: block; margin-top: 15px; font-weight: bold; }
    form input, form textarea {
      width: 100%; padding: 10px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    form textarea { min-height: 220px; }
    .checkboxes { margin-top: 15px; }
    .checkboxes label { font-weight: normal; display: block; margin: 5px 0; }
    button {
      margin-top: 20px; padding: 12px 20px;
      background: #008000; color: #fff; border: none; border-radius: 4px;
      cursor: pointer; font-size: 16px;
    }
    button:hover { background: #006400; }
    .notice { margin-top: 20px; font-size: 0.9em; color: #555; }
    .success { margin-top: 20px; padding: 10px; background: #e0ffe0; border: 1px solid #0a0; }
  </style>
</head>
  <script>
/**
 * Lädt PLZ→WK und WK→MdB und befüllt das Formular.
 * Erwartet folgende Feld-IDs in deiner bestehenden Seite:
 *  - PLZ:           #plz
 *  - MdB-Name:      #abgeordneter
 *  - Brieftext:     #message
 * JSON-Dateien:
 *  - /assets/data/plz_to_wk.json
 *  - /assets/data/wk_to_mdb.json   (liegt schon vor – 276 WK)
 */

async function findMdBByPLZ(plz) {
  try {
    const [plzMap, wkMap] = await Promise.all([
      fetch('/assets/data/plz_to_wk.json').then(r => r.ok ? r.json() : null),
      fetch('/assets/data/wk_to_mdb.json').then(r => r.ok ? r.json() : null),
    ]);
    if (!plzMap || !wkMap) return null;

    const wks = plzMap[plz];
    if (!wks || !wks.length) return null;

    // MVP: nimm den ersten Wahlkreis; (bei Mehrtreffern später Auswahl-UI)
    const wk = String(wks[0]);
    return wkMap[wk] || null;
  } catch {
    return null;
  }
}

function ensureIntroOnce(textarea, anredeZeile) {
  const current = textarea.value || '';
  // Nur dann voranstellen, wenn noch keine Anrede am Anfang steht
  if (!/^\s*Sehr\s/i.test(current)) {
    textarea.value = anredeZeile + "\n\n" + current.trimStart();
  }
}

document.getElementById('plz')?.addEventListener('change', async (e) => {
  const plz = (e.target.value || '').trim();
  if (!/^\d{5}$/.test(plz)) return;

  const mpInput = document.getElementById('abgeordneter');
  const msg = document.getElementById('message');
  if (!msg) return;

  const mdb = await findMdBByPLZ(plz);

  if (mdb) {
    if (mpInput) mpInput.value = mdb.mdb_name || '';
    // Anrede aus JSON verwenden
    const anrede = (mdb.anrede && mdb.anrede.trim()) ? mdb.anrede.trim() : "Sehr geehrte Damen und Herren";
    ensureIntroOnce(msg, anrede);
    // Optional: versteckte Adresse mitschicken (falls gewünscht)
    let addr = document.getElementById('mp_address');
    if (!addr) {
      addr = document.createElement('input');
      addr.type = 'hidden';
      addr.id = 'mp_address';
      addr.name = 'mp_address';
      msg.form?.appendChild(addr);
    }
    addr.value = mdb.bundestag_address || '';
  } else {
    // Fallback für fehlende/noch nicht abgedeckte WK
    if (mpInput) mpInput.value = '';
    ensureIntroOnce(msg, "Sehr geehrte Damen und Herren");
  }
});
</script>

<body>
  <header>
    <img src="assets/logo.png" alt="Kampagnenlogo">
    <h1>Solarstrom statt Erdgas-Strom</h1>
    <p>Sie schreiben den Brief – wir übernehmen Ausdruck & Postversand an die Abgeordneten.</p>
  </header>

  <main>
    <h2>So funktioniert’s</h2>
    <ol>
      <li>Brieftext verfassen und Absenderadresse angeben.</li>
      <li>Der Brief geht an unser Kampagnenteam in die Druck-&-Post-Warteschlange.</li>
      <li>Wir drucken, kuvertieren und versenden physisch an die zuständige/n MdB.</li>
    </ol>

    <h2>Brief einreichen</h2>
    <form id="letterForm" method="post" action="/api/queue">
      <!-- Empfänger -->
      <label for="plz">Ihre PLZ *</label>
      <input type="text" id="plz" name="zip" required>

      <label for="ort">Ort *</label>
      <input type="text" id="ort" name="city" required>

      <label for="abgeordneter">Name der/s Abgeordneten (optional)</label>
      <input type="text" id="abgeordneter" name="mp_name">

      <!-- Absender -->
      <label for="vorname">Vorname *</label>
      <input type="text" id="vorname" name="first_name" required>

      <label for="nachname">Nachname *</label>
      <input type="text" id="nachname" name="last_name" required>

      <label for="email">E-Mail *</label>
      <input type="email" id="email" name="email" required>

      <label for="strasse">Straße & Nr. *</label>
      <input type="text" id="strasse" name="street" required>

      <label for="plz_abs">PLZ (Absender:in) *</label>
      <input type="text" id="plz_abs" name="sender_zip" required>

      <label for="ort_abs">Ort (Absender:in) *</label>
      <input type="text" id="ort_abs" name="sender_city" required>

      <!-- Brief -->
      <label for="subject">Betreff *</label>
      <input type="text" id="subject" name="subject"
             value="Solarstrom vor Erdgas-Strom – bitte setzen Sie klare Prioritäten" required>

      <label for="message">Brieftext</label>
      <textarea id="message" name="message">
Sehr geehrte Damen und Herren,

bitte setzen Sie sich dafür ein, dass Solar-Direktstrom in Deutschland eindeutig Vorrang vor Erdgas-Strom hat – rechtlich wie praktisch. Es braucht:
- klare Prioritäten in Gesetzen und Verordnungen,
- Netz- und Marktdesign, das flexible Direktnutzung fördert,
- weniger Hürden für Prosumer, Kommunen und KMU.

Das stärkt Versorgungssicherheit, senkt Kosten und schützt unsere Lebensgrundlagen.

Mit freundlichen Grüßen
{Vorname} {Nachname}
{Straße}, {PLZ} {Ort}
      </textarea>

      <!-- Optionen -->
      <div class="checkboxes">
        <label><input type="checkbox" id="consent_print" name="consent_print" required>
          Ich willige ein, dass mein Brief an das Kampagnenteam übermittelt, für den Postversand aufbereitet und in meinem Namen mit meiner Absenderadresse physisch versendet wird.
        </label>
        <label><input type="checkbox" id="copy_to_self" name="copy_to_self">
          Kopie an mich per E-Mail senden
        </label>
      </div>

      <button type="submit">In Druckwarteschlange einreichen</button>

      <p class="notice">Hinweis: Sie erhalten eine Bestätigung mit Vorgangs-ID.</p>
      <div id="successMessage" class="success" style="display:none;"></div>
    </form>
  </main>

  <script>
    const form = document.getElementById('letterForm');
    const successBox = document.getElementById('successMessage');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Form -> Plain Object
      const data = Object.fromEntries(new FormData(form).entries());

      // Checkboxen als Boolean
      data.consent_print = !!document.getElementById('consent_print').checked;
      data.copy_to_self  = !!document.getElementById('copy_to_self').checked;

      const res = await fetch(form.action, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(data)
      });

      let json; try { json = await res.json(); } catch { json = {}; }

      if (res.ok && json.queueId) {
        successBox.style.display = 'block';
        successBox.textContent = 'Danke! Wir haben Ihren Brief erhalten. Vorgangs-ID: ' + json.queueId;
        form.reset();
      } else {
        alert('Fehler: ' + (json.error || json.detail || ('HTTP ' + res.status)));
      }
    });
  </script>
</body>
</html>

