<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Solarstrom statt Erdgas-Strom – Brief einreichen</title>
  <meta name="description" content="Reichen Sie Ihren Brief ein – wir drucken, kuvertieren und versenden physisch an die zuständige Bundestagsabgeordnete.">
  <link rel="stylesheet" href="assets/styles.css">

  <style>
    :root { --maxw: 960px; --brand: #0a7d32; }
    body { margin:0; font: 16px/1.5 system-ui, Arial, sans-serif; color:#111; background:#fff; }
    .page { display:grid; grid-template-columns: 1fr minmax(0, var(--maxw)) 1fr; }
    .middle { grid-column: 2; width:100%; padding: 16px; }
    .hero { display:flex; align-items:center; justify-content:center; gap:24px; flex-wrap:wrap; padding: 28px 0 10px; text-align:center; }
    .hero img { width:min(95vw, 620px); height:auto; display:block; }
    .tagline { margin: 8px 0 0; font-size: 1.1rem; color:#333; }
    .cta { display:inline-block; margin-top:10px; padding:10px 16px; background:var(--brand); color:#fff; text-decoration:none; border-radius:6px; }
    main.middle > section { margin: 22px 0; }
    .form-section h2 { margin-top:0; }
    fieldset { border:1px solid #e6e6e6; border-radius:8px; padding:16px; margin:18px 0; }
    legend { padding: 0 6px; font-weight:600; }
    label { display:block; font-weight:600; margin:12px 0 6px; }
    input[type="text"], input[type="email"], select, textarea { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #cfcfcf; border-radius:6px; font:inherit; }
    textarea { min-height: 240px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    .checkbox-inline { display:block; margin: 10px 0; font-weight:400; }
    .actions { margin-top: 16px; }
    button[type="submit"] { padding: 12px 18px; border:0; border-radius:8px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    .notice, .disclaimer { font-size: .92rem; color:#555; }
    .success { display:none; margin-top:14px; padding:12px; border:1px solid #bfe3bf; background:#eefeef; border-radius:6px; color:#145214; }
    footer .legal { text-align:center; display:block; margin: 24px 0 10px; }
    footer a { color: #333; }
  </style>
</head>
<body>
  <div class="page">
    <header class="site-header middle">
      <div class="hero">
        <img src="assets/logo.png" alt="Kampagnenlogo Solarstrom statt Erdgas-Strom">
        <div style="flex-basis:100%"></div>
        <p class="tagline">Sie schreiben den Brief – wir übernehmen Ausdruck und Postversand an die Abgeordneten.</p>
        <a class="cta" href="#brief">Brief einreichen</a>
      </div>
    </header>

    <main class="middle">
      <section class="explainer">
        <h2>So funktioniert’s</h2>
        <ol>
          <li>Sie verfassen Ihren Brief und geben Ihre <strong>Absenderadresse</strong> an.</li>
          <li>Der Brief geht <strong>an uns</strong> und landet in der Druck-&amp;-Post-Warteschlange.</li>
          <li>Wir drucken, kuvertieren und versenden physisch an die zuständige/n MdB.</li>
        </ol>
      </section>

      <section id="brief" class="form-section">
        <h2>Brief einreichen</h2>
        <form id="letterForm" method="post" action="/api/queue" novalidate>
          <fieldset>
            <legend>Ziel-Abgeordnete:r</legend>
            <div class="grid">
              <div><label for="plz">Ihre PLZ *</label><input id="plz" name="zip" inputmode="numeric" pattern="\d{5}" required></div>
              <div><label for="city">Ort *</label><input id="city" name="city" required></div>
            </div>
            <label for="abgeordneter">Name der/s Abgeordneten (optional)</label>
            <input id="abgeordneter" name="mp_name">
          </fieldset>

          <fieldset>
            <legend>Ihre Angaben</legend>
            <div class="grid">
              <div><label for="first_name">Vorname *</label><input id="first_name" name="first_name" required></div>
              <div><label for="last_name">Nachname *</label><input id="last_name" name="last_name" required></div>
            </div>
            <label for="email">E-Mail *</label><input id="email" name="email" type="email" required>
            <label for="street">Straße &amp; Nr. *</label><input id="street" name="street" required>
            <div class="grid">
              <div><label for="sender_zip">PLZ *</label><input id="sender_zip" name="sender_zip" required></div>
              <div><label for="sender_city">Ort *</label><input id="sender_city" name="sender_city" required></div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Brief</legend>
            <label for="subject">Betreff *</label>
            <input id="subject" name="subject" required value="Solarstrom vor Erdgas-Strom – bitte setzen Sie klare Prioritäten">

            <label for="message">Brieftext *</label>
            <textarea id="message" name="message" required>
{MdB_Name_und_Adresse}

{Anrede}

bitte setzen Sie sich dafür ein, dass Solar-Direktstrom in Deutschland eindeutig Vorrang vor Erdgas-Strom hat – rechtlich wie praktisch. Es braucht:
• klare Prioritäten in Gesetzen und Verordnungen,
• Netz- und Marktdesign, das flexible Direktnutzung fördert,
• weniger Hürden für Prosumer, Kommunen und KMU.

Das stärkt Versorgungssicherheit, senkt Kosten und schützt unsere Lebensgrundlagen.

Mit freundlichen Grüßen
{Vorname} {Nachname}
{Straße}
{PLZ} {Ort}
            </textarea>

            <label class="checkbox-inline"><input id="consent_print" name="consent_print" type="checkbox" required> Ich willige ein, dass mein Brief physisch versendet wird.</label>
            <label class="checkbox-inline"><input id="copy_to_self" name="copy_to_self" type="checkbox" checked> Kopie an mich per E-Mail senden</label>
          </fieldset>

          <div class="actions"><button type="submit">In Druckwarteschlange einreichen</button><div id="successMessage" class="success"></div></div>
        </form>
      </section>
    </main>

    <footer class="site-footer middle">
      <nav class="legal"><a href="impressum.html">Impressum</a> · <a href="datenschutz.html">Datenschutz</a></nav>
    </footer>
  </div>

  <!-- Auto-MdB -->
  <script>
  (function () {
    const $ = (s) => document.querySelector(s);
    const elPLZ = $('#plz'), elMP = $('#abgeordneter'), elMSG = $('#message');

    const clean = (s) => String(s||'').replace(/^\s*nan\s+/i,'').trim();

    async function loadJson(url) {
      const res = await fetch(url); if (!res.ok) throw new Error(url); return res.json();
    }
    async function findMdBByPLZ(plz) {
      const [plzMap,wkMap] = await Promise.all([loadJson('assets/data/plz_to_wk.json'), loadJson('assets/data/wk_to_mdb.json')]);
      const wk = plzMap[plz]?.[0]; return wkMap[wk] || null;
    }

    function ensureIntroAndAddress(anrede, addrWithName) {
      // ersetzt NUR die Platzhalter; keine Anrede mehr „nach oben“ schieben
      let txt = elMSG.value || '';

      // Sicher: beide Varianten ersetzen, falls alter Platzhalter noch irgendwo existiert
      txt = txt.replace('{MdB_Name_und_Adresse}', addrWithName || '')
               .replace('{MdB_Adresse}', addrWithName || '')
               .replace('{Anrede}', anrede || '');

      elMSG.value = txt.trimEnd();

      // Vorlage (für spätere Absenderdaten-Ersetzung) speichern
      elMSG.dataset.tpl = elMSG.value;
    }

    async function handlePLZ() {
      const plz = (elPLZ.value||'').trim();
      if (!/^\d{5}$/.test(plz)) return;
      try {
        const mdb = await findMdBByPLZ(plz);
        if (mdb) {
          const name = clean(mdb.mdb_name) || [mdb.vorname, mdb.nachname].filter(Boolean).join(' ');
          if (elMP) elMP.value = name;

          const anrede = clean(mdb.anrede) || 'Sehr geehrte Damen und Herren';
          const addrML  = String(mdb.bundestag_address||'').replace(/\s*\n\s*/g,'\n').trim();
          const addrWithName = (name ? name + '\n' : '') + addrML; // MdB über der Bundestagsadresse

          ensureIntroAndAddress(anrede, addrWithName);
        }
      } catch(e){}
    }

    elPLZ.addEventListener('change', handlePLZ);
    elPLZ.addEventListener('blur', handlePLZ);
  })();
  </script>

  <!-- Token-Ersetzung live (inkl. Straßen-Kommafix) -->
  <script>
  (function(){
    const $ = (s) => document.querySelector(s);
    const form=$('#letterForm'), msg=$('#message');

    const F={'{Vorname}':'#first_name','{Nachname}':'#last_name','{Straße}':'#street','{PLZ}':'#sender_zip','{Ort}':'#sender_city'};
    const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

    // „Musterstraße, 2b“ -> „Musterstraße 2b“
    const cleanStreet = (v) => String(v||'').replace(/\s*,\s*(?=\d)/g,' ').replace(/\s{2,}/g,' ').trim();

    function vals(){
      const m={};
      for (const [tok,sel] of Object.entries(F)) {
        let v = ($(sel)?.value||'').trim();
        if (tok === '{Straße}') v = cleanStreet(v);
        m[tok]=v;
      }
      return m;
    }

    function apply(base,map){
      let out=base;
      for(const[t,v] of Object.entries(map)){
        out=out.replace(new RegExp(esc(t),'g'),v);
      }
      return out.replace(/\n{3,}/g,'\n\n').trimEnd();
    }

    function update(){
      if(!msg)return;
      if(!msg.dataset.tpl) msg.dataset.tpl = msg.value;
      msg.value = apply(msg.dataset.tpl, vals());
    }

    Object.values(F).forEach(sel=>$(sel)?.addEventListener('input',update));
    update();

    form?.addEventListener('submit',e=>{
      update();
      if(/\{Vorname\}|\{Nachname\}|\{Straße\}|\{PLZ\}|\{Ort\}/.test(msg.value)){
        e.preventDefault();
        alert('Bitte füllen Sie alle Absenderfelder aus.');
      }
    });
  })();
  </script>
</body>
</html>
