<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Solarstrom statt Erdgas-Strom – Brief einreichen</title>
  <meta name="description" content="Reichen Sie Ihren Brief ein – wir drucken, kuvertieren und versenden physisch an die zuständige Bundestagsabgeordnete.">
  <link rel="stylesheet" href="assets/styles.css">

  <style>
    :root { --maxw: 960px; --brand: #0a7d32; }
    body { margin:0; font: 16px/1.5 system-ui, Arial, sans-serif; color:#111; background:#fff; }
    .page { display:grid; grid-template-columns: 1fr minmax(0, var(--maxw)) 1fr; }
    .middle { grid-column: 2; width:100%; padding: 16px; }
    .hero { display:flex; align-items:center; justify-content:center; gap:24px; flex-wrap:wrap; padding: 28px 0 10px; text-align:center; }
    .hero img { width:min(95vw, 620px); height:auto; display:block; }
    .tagline { margin: 8px 0 0; font-size: 1.1rem; color:#333; }
    .cta { display:inline-block; margin-top:10px; padding:10px 16px; background:var(--brand); color:#fff; text-decoration:none; border-radius:6px; }
    main.middle > section { margin: 22px 0; }
    .form-section h2 { margin-top:0; }
    fieldset { border:1px solid #e6e6e6; border-radius:8px; padding:16px; margin:18px 0; }
    legend { padding: 0 6px; font-weight:600; }
    label { display:block; font-weight:600; margin:12px 0 6px; }
    input[type="text"], input[type="email"], select, textarea { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #cfcfcf; border-radius:6px; font:inherit; }
    textarea { min-height: 240px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    .checkbox-inline { display:flex; align-items:flex-start; gap:8px; margin: 8px 0; font-weight:500; }
    .checkbox-inline input{ margin-top:3px; }
    .actions { margin-top: 16px; }
    button[type="submit"] { padding: 12px 18px; border:0; border-radius:8px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    .notice, .disclaimer { font-size: .92rem; color:#555; }
    .success { display:none; margin-top:14px; padding:12px; border:1px solid #bfe3bf; background:#eefeef; border-radius:6px; color:#145214; }
    footer .legal { text-align:center; display:block; margin: 24px 0 10px; }
    footer a { color: #333; }
    .hint { font-size:.9rem; color:#555; margin:6px 0 0; }

    /* hübscher Consent-Block */
    .consent-card{
      border:1px solid #e6e6e6; border-radius:10px; padding:12px 14px; background:#fafafa;
      margin-top:14px;
    }
    .consent-card h4{
      margin:0 0 8px; font-size:1rem; font-weight:700;
    }
    .consent-card .sub{
      margin:4px 0 0; font-size:.9rem; color:#666; font-weight:400;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="site-header middle">
      <div class="hero">
        <!-- Logo klickbar zur Homepage -->
        <a href="https://www.aktionsolarstrom.de/" aria-label="Zur Startseite">
          <img src="assets/logo.png" alt="Kampagnenlogo Solarstrom statt Erdgas-Strom">
        </a>
        <div style="flex-basis:100%"></div>
        <p class="tagline">Sie schreiben den Brief – wir übernehmen Ausdruck und Postversand an die Abgeordneten.</p>
        <a class="cta" href="#brief">Brief einreichen</a>
      </div>
    </header>

    <main class="middle">
      <section class="explainer">
        <h2>So funktioniert’s</h2>
        <ol>
          <li>Sie verfassen Ihren Brief und geben Ihre <strong>Absenderadresse</strong> an.</li>
          <li>Der Brief geht <strong>an uns</strong> und landet in der Druck-&amp;-Post-Warteschlange.</li>
          <li>Wir drucken, kuvertieren und versenden physisch an die zuständige/n MdB.</li>
        </ol>
      </section>

      <section id="brief" class="form-section">
        <h2>Brief einreichen</h2>
        <form id="letterForm" method="post" action="/api/queue" novalidate>
          <fieldset>
            <legend>Ziel-Abgeordnete:r</legend>
            <div class="grid">
              <div><label for="plz">Ihre PLZ *</label><input id="plz" name="zip" inputmode="numeric" pattern="\d{5}" required></div>
              <div><label for="city">Ort *</label><input id="city" name="city" required></div>
            </div>
            <label for="abgeordneter">Name der/s Abgeordneten (optional)</label>
            <input id="abgeordneter" name="mp_name">

            <div id="mpSelectWrap" style="display:none; margin-top:8px;">
              <label for="mp_select">Treffer in Ihrem Ort</label>
              <select id="mp_select"></select>
              <div class="hint" id="mp_hint"></div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Ihre Angaben</legend>
            <div class="grid">
              <div><label for="first_name">Vorname *</label><input id="first_name" name="first_name" required></div>
              <div><label for="last_name">Nachname *</label><input id="last_name" name="last_name" required></div>
            </div>
            <label for="email">E-Mail *</label><input id="email" name="email" type="email" required>
            <label for="street">Straße &amp; Nr. *</label><input id="street" name="street" required>
            <div class="grid">
              <div><label for="sender_zip">PLZ *</label><input id="sender_zip" name="sender_zip" required></div>
              <div><label for="sender_city">Ort *</label><input id="sender_city" name="sender_city" required></div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Brief</legend>
            <label for="subject">Betreff *</label>
            <input id="subject" name="subject" required value="Sonnenstrom statt Erdgasstrom – bitte setzen Sie klare Prioritäten">

            <label for="message">Brieftext *</label>
            <textarea id="message" name="message" required>
{MdB_Name_und_Adresse}

{Anrede}

heute wende ich mich an Sie mit einem Thema, das für viele Bürgerinnen, Bürger und Unternehmen in Ihrem Wahlkreis sehr relevant ist: Die Fortsetzung der Energiewende.

Bürgerinnen und Bürger, Unternehmen und Kommunen investieren mit Photovoltaik und Speicher in die Energiewende und den Klimaschutz. Die so produzierte Energie nutzen sie zu einem guten Teil selbst. Sie sparen damit Stromkosten und tragen zu unseren Klimazielen bei. 

Doch jetzt ist diese erfolgreiche Entwicklung bedroht. Bundesministerin Reiche möchte die Energiewende drosseln, die feste Einspeisevergütung abschaffen und neue Erdgaskraftwerke bauen. Außerdem bereitet die Bundesnetzagentur mit ihrem Diskussionspapier AgNes eine massive Verschlechterung der Wirtschaftlichkeit für Produzenten von erneuerbarem Strom vor. 

Deshalb möchte ich Sie für die Forderungen der Initiative „Sonnenstrom statt Erdgasstrom“ gewinnen, die die deutschen Stromkunden und das Klima entlasten: 

1. Keine neuen Erdgaskraftwerke. Spitzenlast mit Bioenergie, Wasserkraft und Speichern abdecken.

2. Ausbau Erneuerbarer beschleunigen – und netzdienliche Erzeugung belohnen.

3. Feste Einspeisevergütung beibehalten bis Smart Meter flächendeckend eine einfache, flexible Vergütung erlauben.

4. Bestandsschutz und keine Zusatzbelastung für erneuerbare Stromerzeugung.

Dieser Brief entstand mit der Aktion „Sonnenstrom statt Erdgasstrom“. Weitere Informationen zu den Plänen von Frau Reiche und der BNetzA finden Sie auf https://www.aktionsolarstrom.de.

Vielen Dank für ihre Aufmerksamkeit. Es würde mich sehr freuen von Ihnen zu hören.

Mit freundlichen Grüßen

{Vorname} {Nachname}
{Straße}
{PLZ} {Ort}
            </textarea>

            <!-- Hübscher Consent-Block -->
            <div class="consent-card" aria-labelledby="consentTitle">
              <h4 id="consentTitle">Versand & Benachrichtigung</h4>
              <label class="checkbox-inline">
                <input id="consent_print" name="consent_print" type="checkbox" required>
                <span>Ich willige ein, dass mein Brief <strong>physisch versendet</strong> wird.</span>
              </label>
              <label class="checkbox-inline">
                <input id="copy_to_self" name="copy_to_self" type="checkbox" checked>
                <span>Kopie an mich per E-Mail senden</span>
              </label>
              <p class="sub">Wir verwenden Ihre Angaben ausschließlich zur Zustellung des Briefes. Details siehe Datenschutz.</p>
            </div>
          </fieldset>

          <div class="actions">
            <button type="submit">In Druckwarteschlange einreichen</button>
            <div id="successMessage" class="success"></div>
          </div>
        </form>
      </section>
    </main>

    <footer class="site-footer middle">
      <nav class="legal">
        <a href="https://www.aktionsolarstrom.de/">Zur Startseite</a> ·
        <a href="impressum.html">Impressum</a> ·
        <a href="datenschutz.html">Datenschutz</a>
      </nav>
    </footer>
  </div>

  <!-- ==== DEBUG-HOOK (aktiv mit ?debug=1) ==== -->
  <script>
  (function(){
    const DEBUG = /[?&]debug=1/.test(location.search);
    const badge = document.createElement('div');
    function show(msg, ok=false){
      if(!DEBUG) return;
      badge.textContent = 'MDB: ' + msg;
      badge.style.cssText = 'position:fixed;right:8px;bottom:8px;z-index:99999;padding:6px 8px;border-radius:6px;font:12px/1.2 system-ui;background:'+(ok?'#e8f7ec':'#fff3cd')+';border:1px solid '+(ok?'#7ad08d':'#e6c45c')+';color:#222';
      document.body.appendChild(badge);
      console.log('[MDB]', msg);
    }
    window._mdblog = { show, DEBUG };
    window._fetchJson = async function(url){
      const bust = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
      try{
        const res = await fetch(bust, { cache:'no-store' });
        if(!res.ok){ show('Fetch FAIL '+url+' ('+res.status+')'); throw new Error(url+' '+res.status); }
        const j = await res.json();
        show('Fetch OK '+url, true);
        return j;
      }catch(e){
        show('Fetch ERR '+url+': '+e);
        throw e;
      }
    };
  })();
  </script>

  <!-- Auto-MdB -->
  <script>
  (function () {
    const $ = (s) => document.querySelector(s);
    const elPLZ = $('#plz'), elCity = $('#city');
    const elMP = $('#abgeordneter'), elMSG = $('#message');
    const selWrap = $('#mpSelectWrap'), elSel = $('#mp_select'), elHint = $('#mp_hint');

    const clean = (s) => String(s||'').replace(/^\s*nan\s+/i,'').trim();
    const norm = (t) => String(t||'')
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^\w\s]/g,'').replace(/\s+/g,' ')
      .trim().toLowerCase();

    async function loadJson(url){ return _fetchJson(url); }

    async function findCandidates(plz, cityRaw) {
      _mdblog.show('Start Lookup PLZ='+plz+' Ort='+cityRaw);
      const [plzMap, wkMap, ortMap] = await Promise.all([
        loadJson('assets/data/plz_to_wk.json'),
        loadJson('assets/data/wk_to_mdb.json'),
        loadJson('assets/data/ort_to_wk.json'),
      ]);

      let wks = plzMap[plz] || [];
      _mdblog.show('PLZ→WK: '+JSON.stringify(wks));

      const cityKey = norm(cityRaw);

      if ((!wks || !wks.length) && cityKey) {
        const hits = Object.entries(ortMap).filter(([k]) => k.startsWith(cityKey)).map(([, arr]) => arr);
        wks = [...new Set(hits.flat())];
        _mdblog.show('Fallback ORT→WK: '+JSON.stringify(wks));
      }

      if (wks.length > 1 && cityKey) {
        const hits = Object.entries(ortMap).filter(([k]) => k.startsWith(cityKey)).map(([, arr]) => arr);
        const byCity = new Set([].concat(...hits));
        const narrowed = wks.filter(w => byCity.has(String(w)));
        if (narrowed.length) { wks = narrowed; _mdblog.show('Eingrenzung via Ort: '+JSON.stringify(wks), true); }
      }

      const candidates = (wks||[])
        .map(wk => wkMap[String(wk)])
        .filter(Boolean)
        .map(m => ({
          wk: String((m.wk_nr || m.wk || '')),
          name: clean(m.mdb_name),
          party: clean(m.fraktion || m.party || ''),
          anrede: clean(m.anrede) || ('Sehr geehrte/r ' + clean(m.mdb_name)),
          address: (m.bundestag_address || 'Platz der Republik 1\n11011 Berlin').replace(/\s*\n\s*/g,'\n').trim()
        }));

      _mdblog.show('Kandidaten: '+candidates.length, true);
      return { wks: [...new Set((wks||[]).map(String))], candidates };
    }

    // MdB in die BASIS-Vorlage einsetzen → neue tpl bauen (mit "Deutscher Bundestag" vor der Straße)
    function ensureIntroOnBase(anrede, addr, name) {
      const base = elMSG.dataset.base || elMSG.value || '';
      const addrLine = (addr || 'Platz der Republik 1\n11011 Berlin').replace(/\s*\n\s*/g,'\n').trim();
      const addrBlock = ((name ? name : '') + '\nDeutscher Bundestag\n' + addrLine).trim();
      const tpl = base
        .replace('{MdB_Name_und_Adresse}', addrBlock)
        .replace('{MdB_Adresse}', addrBlock)
        .replace('{Anrede}', anrede || 'Sehr geehrte Damen und Herren');
      elMSG.dataset.tpl = tpl;
      ['#sender_zip','#sender_city'].forEach(sel =>
        document.querySelector(sel)?.dispatchEvent(new Event('input'))
      );
    }

    function hideSelect() {
      if (selWrap) selWrap.style.display = 'none';
      if (elSel) { elSel.innerHTML = ''; }
      if (elHint) elHint.textContent = '';
    }

    function showSelect(cands, wks) {
      if (!selWrap || !elSel) return;
      elSel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Bitte Abgeordnete:n auswählen …';
      elSel.appendChild(opt0);

      cands.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name; // Value bleibt nur der Name
        opt.textContent = c.name + (c.party ? ' – ' + c.party : '');
        opt.dataset.anrede = c.anrede;
        opt.dataset.address = c.address;
        elSel.appendChild(opt);
      });

      elHint.textContent = 'Mehrere Wahlkreise (' + wks.join(', ') + ').';
      selWrap.style.display = 'block';
    }

    function chooseCandidateByName(name) {
      if (!name) return;
      const opt = [...elSel.options].find(o => o.value === name);
      const anrede = opt?.dataset?.anrede || ('Sehr geehrte/r ' + name);
      const address = opt?.dataset?.address || 'Platz der Republik 1\n11011 Berlin';
      elMP.value = name;
      ensureIntroOnBase(anrede, address, name);
    }

    elSel?.addEventListener('change', () => {
      const name = elSel.value;
      if (!name) return;
      _mdblog.show('Auswahl: '+name, true);
      chooseCandidateByName(name);
    });

    elMP?.addEventListener('blur', () => {
      const name = (elMP.value||'').trim();
      if (name) chooseCandidateByName(name);
    });

    // --- Debounce Steuerung ---
    let lookupTimer = null;
    function scheduleLookup(delay = 350) {
      clearTimeout(lookupTimer);
      lookupTimer = setTimeout(runLookup, delay);
    }

    // Basisvorlage einmalig sichern
    if (!elMSG.dataset.base) elMSG.dataset.base = elMSG.value;

    // PLZ: sobald 5 Ziffern → sofort lookup
    elPLZ?.addEventListener('input', () => {
      const v = (elPLZ.value || '').trim();
      if (/^\d{5}$/.test(v)) scheduleLookup(0);
    });

    // Ort: ab 3 Zeichen → debounce 350ms
    elCity?.addEventListener('input', () => {
      const v = (elCity.value || '').trim();
      if (v.length >= 3) scheduleLookup(350);
    });

    // Fallback: change/blur
    ['change','blur'].forEach(ev=>{
      elPLZ?.addEventListener(ev, runLookup);
      elCity?.addEventListener(ev, runLookup);
    });

    async function runLookup() {
      hideSelect();
      const plz  = (elPLZ?.value||'').trim();
      const city = (elCity?.value||'').trim();
      if (!/^\d{5}$/.test(plz)) { _mdblog.show('PLZ ungültig'); return; }

      try {
        const { wks, candidates } = await findCandidates(plz, city);

        if (candidates.length === 1) {
          const c = candidates[0];
          elMP.value = c.name;
          ensureIntroOnBase(c.anrede, c.address, c.name);
        } else if (candidates.length > 1) {
          elMP.value = '';
          ensureIntroOnBase('Sehr geehrte Damen und Herren', 'Platz der Republik 1\n11011 Berlin', '');
          showSelect(candidates, wks);
        } else {
          elMP.value = '';
          ensureIntroOnBase('Sehr geehrte Damen und Herren', 'Platz der Republik 1\n11011 Berlin', '');
        }
      } catch (e) {
        _mdblog.show('Lookup ERROR: '+e);
        elMP.value = '';
        ensureIntroOnBase('Sehr geehrte Damen und Herren', 'Platz der Republik 1\n11011 Berlin', '');
      }
    }
  })();
  </script>

  <!-- Token-Ersetzung live -->
  <script>
  (function(){
    const $ = (s) => document.querySelector(s);
    const form=$('#letterForm'), msg=$('#message');

    const F={'{Vorname}':'#first_name','{Nachname}':'#last_name','{Straße}':'#street','{PLZ}':'#sender_zip','{Ort}':'#sender_city'};
    const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

    const topPLZ  = () => ($('#plz')?.value||'').trim();
    const topCity = () => ($('#city')?.value||'').trim();

    const cleanStreet = (v) => String(v||'').replace(/\s*,\s*(?=\d)/g,' ').replace(/\s{2,}/g,' ').trim();

    function getTpl(){ return msg.dataset.tpl || msg.dataset.base || msg.value || ''; }

    function vals(){
      const m={};
      for (const [tok,sel] of Object.entries(F)) {
        let v = ($(sel)?.value||'').trim();
        if (tok === '{Straße}') v = cleanStreet(v);
        if (tok === '{PLZ}' && !v) v = topPLZ();
        if (tok === '{Ort}' && !v) v = topCity();
        m[tok]=v;
      }
      return m;
    }

    function apply(base,map){
      let out=base;
      for(const[t,v] of Object.entries(map)){
        out=out.replace(new RegExp(esc(t),'g'),v);
      }
      return out.replace(/\n{3,}/g,'\n\n').trimEnd();
    }

    function update(){
      if(!msg)return;
      if(!msg.dataset.base) msg.dataset.base = msg.value;  // Basis sichern
      if(!msg.dataset.tpl)  msg.dataset.tpl  = msg.dataset.base; // Starttpl
      msg.value = apply(getTpl(), vals());
    }

    [...Object.values(F), '#plz', '#city', '#sender_zip', '#sender_city'].forEach(sel=>$(sel)?.addEventListener('input',update));
    update();

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      update();

      if (/\{Vorname\}|\{Nachname\}|\{Straße\}|\{PLZ\}|\{Ort\}/.test(msg.value)) {
        alert('Bitte füllen Sie alle Absenderfelder aus.');
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn?.setAttribute('disabled','');

      const fd = new FormData(form);
      const body = {};
      fd.forEach((v,k)=>body[k]=v);
      body.copy_to_self  = fd.has('copy_to_self');
      body.consent_print = fd.has('consent_print');

      try{
        const res = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.ok){
          const box = document.getElementById('successMessage');
          box.textContent = 'Danke! Ihr Brief wurde erfolgreich eingereicht. Vorgangs-ID: ' + (data.queueId||'');
          box.style.display = 'block';
          form.reset();
          // Vorlage zurücksetzen
          msg.value = msg.dataset.base;
          msg.dataset.tpl = msg.dataset.base;
          update();
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannt'));
        }
      } catch(err){
        alert('Verbindungsfehler: ' + err.message);
      } finally {
        btn?.removeAttribute('disabled');
      }
    });
  })();
  </script>
</body>
</html>





















